
{% extends 'algosite/base.html' %}
{% load form_tags %}

{% block title %}Отправить новую тему{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>Отправить новую тему</h2>

  {% if message %}
    <div class="alert alert-success">{{ message }}</div>
  {% endif %}

  <form method="post" novalidate>
    {% csrf_token %}

    <div class="mb-3">
      {{ form.title.label_tag }}
      {{ form.title|add_class:"form-control" }}
      {{ form.title.errors }}
    </div>

    <div class="mb-3">
      {{ form.explanation.label_tag }}
      {{ form.explanation|add_class:"form-control" }}
      {{ form.explanation.errors }}
    </div>

    <div class="mb-3">
      {{ form.example_code.label_tag }}
      {{ form.example_code|add_class:"form-control" }}
      {{ form.example_code.errors }}
    </div>

    <div class="mb-3">
      {{ form.exercise_render_code.label_tag }}
      {{ form.exercise_render_code|add_class:"form-control" }}
      {{ form.exercise_render_code.errors }}
    </div>

    <div class="mb-3">
      {{ form.exercise_logic_code.label_tag }}
      {{ form.exercise_logic_code|add_class:"form-control" }}
      {{ form.exercise_logic_code.errors }}
    </div>

    <button type="submit" class="btn btn-primary w-100">Отправить</button>
  </form>

  <h3 class="mt-4">Превью упражнения</h3>
  <div id="preview" class="border p-4 bg-white rounded" style="min-height: 400px;"></div>

  <a href="{% url 'index' %}" class="d-block mt-3 text-center text-primary">Назад на главную</a>
</div>

<script>
  const renderInput = document.getElementById('id_exercise_render_code');
  const logicInput = document.getElementById('id_exercise_logic_code');
  const preview = document.getElementById('preview');

  function updatePreview() {
    preview.innerHTML = renderInput.value;

    const oldScripts = preview.querySelectorAll('script');
    oldScripts.forEach(s => s.remove());

    if (logicInput.value.trim()) {
      const script = document.createElement('script');
      script.text = logicInput.value;
      preview.appendChild(script);
    }
  }
  renderInput.addEventListener('input', updatePreview);

  logicInput.addEventListener('input', updatePreview);
  updatePreview();
</script>
{% endblock %}
